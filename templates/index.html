<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Records</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .filter-input {
            width: 100%;
            box-sizing: border-box;
        }
        #dialog {
            display: none; /* Initially hidden */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border: 2px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #overlay {
            display: none; /* Initially hidden */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <h1>Records from DynamoDB</h1>
    <div id="filter-section">
        <input type="text" class="filter-input" placeholder="Filter Ticker" />
        <input type="text" class="filter-input" placeholder="Filter Option" />
        <input type="text" class="filter-input" placeholder="Filter Short Contract" />
        <input type="text" class="filter-input" placeholder="Filter Credit" />
        <input type="text" class="filter-input" placeholder="Filter Long Contract" />
        <input type="text" class="filter-input" placeholder="Filter Debit" />
        <input type="text" class="filter-input" placeholder="Filter Max Risk" />
        <input type="text" class="filter-input" placeholder="Filter Max Reward" />
        <input type="text" class="filter-input" placeholder="Filter Breakeven" />
        <input type="text" class="filter-input" placeholder="Filter Entry Price" />
        <input type="text" class="filter-input" placeholder="Filter Target Price" />
        <input type="text" class="filter-input" placeholder="Filter Stop Price" />
        <input type="text" class="filter-input" placeholder="Filter Exit Date" />
    </div>
    <table id="data-table" border="1">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Option</th>
                <th>Short Contract</th>
                <th>Credit</th>
                <th>Long Contract</th>
                <th>Debit</th>
                <th>Max Risk</th>
                <th>Max Reward</th>
                <th>Breakeven</th>
                <th>Entry Price</th>
                <th>Target Price</th>
                <th>Stop Price</th>
                <th>Exit Date</th>
                <th>View Description</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="overlay"></div>
    <div id="dialog">
        <h2>Description</h2>
        <p id="description-content"></p>
        <button id="close-dialog">Close</button>
    </div>

    <script>
        $(document).ready(function() {
            let previousData = [];

            function refreshData() {
                $.ajax({
                    url: '/data',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        previousData = data; // Store the original data for filtering
                        renderTable(data); // Render the initial table
                    },
                    error: function(error) {
                        console.error("Error loading data:", error);
                    }
                });
            }

            function renderTable(data) {
                $('#data-table tbody').empty(); // Clear the previous data
                const filteredData = data.filter(item => item.exit_date_str); // Filter out items where exit_date_str is 'N/A'

                $.each(filteredData, function(index, item) {
                    let row = $('<tr>');
                    row.append(`<td>${item.underlying_ticker || 'N/A'}</td>`);
                    
                    // Parse and display the option object instead of as a string
                    let optionContent = {};
                    try {
                        optionContent = JSON.parse(item.option || '{}');
                    } catch (e) {
                        console.error("Error parsing option JSON:", e);
                    }
                    row.append(`<td>${JSON.stringify(optionContent) || 'N/A'}</td>`); // Display parsed option data
                    row.append(`<td>${item.short_contract ? item.short_contract.ticker + ' (' + item.short_contract.strike_price + ')' : 'N/A'}</td>`);
                    row.append(`<td>${item.short_premium || 'N/A'}</td>`);
                    row.append(`<td>${item.long_contract ? item.long_contract.ticker + ' (' + item.long_contract.strike_price + ')' : 'N/A'}</td>`);
                    row.append(`<td>${item.long_premium || 'N/A'}</td>`);
                    row.append(`<td>${item.max_risk || 'N/A'}</td>`);
                    row.append(`<td>${item.max_reward || 'N/A'}</td>`);
                    row.append(`<td>${item.breakeven || 'N/A'}</td>`);
                    row.append(`<td>${item.entry_price || 'N/A'}</td>`);
                    row.append(`<td>${item.target_price || 'N/A'}</td>`);
                    row.append(`<td>${item.stop_price || 'N/A'}</td>`);
                    row.append(`<td>${item.exit_date_str || 'N/A'}</td>`);
                    
                    // Add a button to view the description
                    row.append(`<td><button class="view-description" data-description="${item.description || 'N/A'}">View</button></td>`);
                    
                    $('#data-table tbody').append(row);
                });
            }

            // Show description dialog
            $(document).on('click', '.view-description', function() {
                const description = $(this).data('description');
                $('#description-content').text(description); // Set the description text
                $('#overlay').show(); // Show the overlay
                $('#dialog').show(); // Show the dialog
            });

            // Close dialog
            $('#close-dialog').on('click', function() {
                $('#overlay').hide(); // Hide the overlay
                $('#dialog').hide(); // Hide the dialog
            });

            // Attach filter input event handlers
            $('.filter-input').on('keyup', function() {
                const filters = [];
                $('.filter-input').each(function() {
                    filters.push($(this).val().toLowerCase()); // Collect filter values
                });

                const filteredData = previousData.filter(item => {
                    return (
                        (item.underlying_ticker || '').toLowerCase().includes(filters[0]) &&
                        //(JSON.stringify(item.option).toLowerCase()).includes(filters[1]) &&
                        (item.short_contract ? item.short_contract.ticker + ' (' + item.short_contract.strike_price + ')' : 'N/A').toLowerCase().includes(filters[2]) &&
                        (item.short_premium || '').toString().toLowerCase().includes(filters[3]) &&
                        (item.long_contract ? item.long_contract.ticker + ' (' + item.long_contract.strike_price + ')' : 'N/A').toLowerCase().includes(filters[4]) &&
                        (item.long_premium || '').toString().toLowerCase().includes(filters[5]) &&
                        (item.max_risk || '').toString().toLowerCase().includes(filters[6]) &&
                        (item.max_reward || '').toString().toLowerCase().includes(filters[7]) &&
                        (item.breakeven || '').toString().toLowerCase().includes(filters[8]) &&
                        (item.entry_price || '').toString().toLowerCase().includes(filters[9]) &&
                        (item.target_price || '').toString().toLowerCase().includes(filters[10]) &&
                        (item.stop_price || '').toString().toLowerCase().includes(filters[11]) &&
                        (item.exit_date_str || '').toLowerCase().includes(filters[12])
                    );
                });

                renderTable(filteredData); // Render the filtered data
            });

            refreshData(); // Initial data loading
        });
    </script>
</body>
</html>