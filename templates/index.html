<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Records</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .filter-input {
            width: 100%;
            box-sizing: border-box;
        }
        #dialog {
            display: none; /* Initially hidden */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border: 2px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #overlay {
            display: none; /* Initially hidden */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <h1>Records from DynamoDB</h1>
    <div id="filter-section">
        <input type="text" class="filter-input" placeholder="Filter Ticker" />
        <input type="text" class="filter-input" placeholder="Filter Option" />
        <input type="text" class="filter-input" placeholder="Filter Credit" />
        <input type="text" class="filter-input" placeholder="Filter Debit" />
        <input type="text" class="filter-input" placeholder="Filter Max Risk" />
        <input type="text" class="filter-input" placeholder="Filter Max Reward" />
        <input type="text" class="filter-input" placeholder="Filter Breakeven" />
        <input type="text" class="filter-input" placeholder="Filter Entry Price" />
        <input type="text" class="filter-input" placeholder="Filter Target Price" />
        <input type="text" class="filter-input" placeholder="Filter Stop Price" />
        <input type="text" class="filter-input" placeholder="Filter Exit Date" />
    </div>
    
    <table id="data-table" border="1">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Option</th>
                <th>Credit</th>
                <th>Debit</th>
                <th>Max Risk</th>
                <th>Max Reward</th>
                <th>Breakeven</th>
                <th>Entry Price</th>
                <th>Target Price</th>
                <th>Stop Price</th>
                <th>Exit Date</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="overlay"></div>
    <div id="dialog">
        <h2>Details</h2>
        <p id="short-contract-content"></p>
        <p id="long-contract-content"></p>
        <p id="description-content"></p>
        <button id="close-dialog">Close</button>
    </div>

    <script>
        $(document).ready(function() {
            let previousData = [];

            function refreshData() {
                $.ajax({
                    url: '/data',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        previousData = data; // Store the original data for filtering
                        renderTable(data); // Render the initial table
                    },
                    error: function(error) {
                        console.error("Error loading data:", error);
                    }
                });
            }

            function renderTable(data) {
                $('#data-table tbody').empty(); // Clear previous data

                const filteredData = data.filter(item => item.exit_date_str);
                $.each(filteredData, function(index, item) {
                    let row = $('<tr>');
                    row.append(`<td>${item.underlying_ticker || 'N/A'}</td>`);
                    const optionData =item.option; // Get the option string from data attribute
                    let optionContent = {};
                    let optionHtml = ``;
                    try {
                        optionContent = JSON.parse(item.option || '{}');
                        for (const key in optionContent) {
                            optionHtml += `<strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${optionContent[key]}<br>`;
                        }

                    } catch (e) {
                        console.error("Error parsing option JSON:", e);
                        optionHtml = 'N/A'; // Handle parsing errors gracefully
                    }
                    row.append(`<td>${optionHtml}</td>`);
                    row.append(`<td>${item.short_premium || 'N/A'}</td>`);
                    row.append(`<td>${item.long_premium || 'N/A'}</td>`);
                    row.append(`<td>${item.max_risk || 'N/A'}</td>`);
                    row.append(`<td>${item.max_reward || 'N/A'}</td>`);
                    row.append(`<td>${item.breakeven || 'N/A'}</td>`);
                    row.append(`<td>${item.entry_price || 'N/A'}</td>`);
                    row.append(`<td>${item.target_price || 'N/A'}</td>`);
                    row.append(`<td>${item.stop_price || 'N/A'}</td>`);
                    row.append(`<td>${item.exit_date_str || 'N/A'}</td>`);
                    
                    // Add a button to view the details
                    // Add a button to view the details, including short and long contract data
                    row.append(`<td>
                            <button 
                                class="view-description" 
                                data-description="${item.description || 'N/A'}" 
                                data-short-contract="${item.short_contract ? item.short_contract.ticker + ' (' + item.short_contract.strike_price + ')' : 'N/A'}" 
                                data-long-contract="${item.long_contract ? item.long_contract.ticker + ' (' + item.long_contract.strike_price + ')' : 'N/A'}">
                                Details
                            </button>
                        </td>`);
                    $('#data-table tbody').append(row);
                });
            }

            // Show details dialog
            $(document).on('click', '.view-description', function() {
                const description = $(this).data('description');
                const shortContract = $(this).data('short-contract');
                const longContract = $(this).data('long-contract');

                // Set the content in the dialog
                $('#description-content').text(description); // Set the description text
                $('#short-contract-content').text(shortContract); // Set the short contract text
                $('#long-contract-content').text(longContract); // Set the long contract text

                $('#overlay').show(); // Show the overlay
                $('#dialog').show(); // Show the dialog
            });
            // Close dialog
            $('#close-dialog').on('click', function() {
                $('#overlay').hide(); // Hide the overlay
                $('#dialog').hide(); // Hide the dialog
            });

            $('.filter-input').on('keyup', function() {
                const filters = $('.filter-input').map(function() {
                    return $(this).val().toLowerCase();
                }).get();

                const filteredData = previousData.filter(item => {
                        return (
                            (item.underlying_ticker || '').toLowerCase().includes(filters[0]) &&
                            (JSON.stringify(item.option).toLowerCase()).includes(filters[1]) &&
                            (item.short_premium || '').toString().toLowerCase().includes(filters[2]) &&
                            (item.long_premium || '').toString().toLowerCase().includes(filters[3]) &&
                            (item.max_risk || '').toString().toLowerCase().includes(filters[4]) &&
                            (item.max_reward || '').toString().toLowerCase().includes(filters[5]) &&
                            (item.breakeven || '').toString().toLowerCase().includes(filters[6]) &&
                            (item.entry_price || '').toString().toLowerCase().includes(filters[6]) &&
                            (item.target_price || '').toString().toLowerCase().includes(filters[8]) &&
                            (item.stop_price || '').toString().toLowerCase().includes(filters[9]) &&
                            (item.exit_date_str || '').toLowerCase().includes(filters[10])
                        );
                });
                renderTable(filteredData);
            });
        refreshData();
        });
    </script>
</body>
</html>