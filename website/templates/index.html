<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Records</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .filter-input {
            width: 100%;
            box-sizing: border-box;
        }
        #dialog {
            display: none; /* Initially hidden */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border: 2px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #overlay {
            display: none; /* Initially hidden */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <h1>Records from DynamoDB</h1>
    <div id="filter-section">
        <input type="text" class="filter-input" placeholder="Filter Ticker" />
        <input type="text" class="filter-input" placeholder="Filter Option" />
        <label>
            <input type="checkbox" id="filter-exit-date" checked /> Show only records with a spread strategy
        </label>
    </div>
    
    <table id="data-table" border="1">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Option</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="overlay"></div>
    <div id="dialog">
        <h2>Details</h2>
        <dl>
            <dt>Credit:</dt> <dd id="credit-content"></dd>
            <dt>Debit:</dt> <dd id="debit-content"></dd>
            <dt>Max Risk:</dt> <dd id="max-risk-content"></dd>
            <dt>Max Reward:</dt> <dd id="max-reward-content"></dd>
            <dt>Breakeven:</dt> <dd id="breakeven-content"></dd>
            <dt>Entry Price:</dt> <dd id="entry-price-content"></dd>
            <dt>Target Price:</dt> <dd id="target-price-content"></dd>
            <dt>Stop Price:</dt> <dd id="stop-price-content"></dd>
            <dt>Exit Date:</dt> <dd id="exit-date-content"></dd>
            <dt>Short Contract:</dt> <dd id="short-contract-content"></dd>
            <dt>Long Contract:</dt> <dd id="long-contract-content"></dd>
            <dt>Description:</dt> <dd id="description-content"></dd>
        </dl>
        <button id="close-dialog">Close</button>
    </div>

    <script>
        $(document).ready(function() {
            let previousData = [];

            function refreshData() {
                $.ajax({
                    url: '/data',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        previousData = data; // Store the original data for filtering
                        renderTable(data); // Render the initial table
                    },
                    error: function(error) {
                        console.error("Error loading data:", error);
                    }
                });
            }

            function renderTable(data) {
                $('#data-table tbody').empty(); // Clear previous data

                const filterExitDate = $('#filter-exit-date').is(':checked');
                const filteredData = filterExitDate ? data.filter(item => item.exit_date) : data;

                $.each(filteredData, function(index, item) {
                    let row = $('<tr>'); // Variable 'row' is used here
                    row.append(`<td>${item.underlying_ticker || 'N/A'}</td>`);
                    
                    let optionHtml = '';
                    if (item.short_contract && item.long_contract) {
                        optionHtml = `Short: ${item.short_contract.ticker} (${item.short_contract.strike_price})<br>
                                      Long: ${item.long_contract.ticker} (${item.long_contract.strike_price})`;
                    } else {
                        optionHtml = 'N/A';
                    }
                    row.append(`<td>${optionHtml}</td>`);
                    
                    // Add a button to view the details
                    const detailsButton = $(`<td >
                                        <button class="view-description" 
                                                data-short_premium="${item.short_premium || 'N/A'}" 
                                                data-long_premium="${item.long_premium || 'N/A'}" 
                                                data-max_risk="${item.max_risk || 'N/A'}" 
                                                data-max_reward="${item.max_reward || 'N/A'}" 
                                                data-breakeven="${item.breakeven || 'N/A'}" 
                                                data-entry_price="${item.entry_price || 'N/A'}" 
                                                data-target_price="${item.target_price || 'N/A'}" 
                                                data-stop_price="${item.stop_price || 'N/A'}" 
                                                data-exit_date="${item.exit_date || 'N/A'}" 
                                                data-short_contract="${item.short_contract ? item.short_contract.ticker + ' (' + item.short_contract.strike_price + ')' : 'N/A'}" 
                                                data-long_contract="${item.long_contract ? item.long_contract.ticker + ' (' + item.long_contract.strike_price + ')' : 'N/A'}" 
                                                data-description="${item.description || 'N/A'}">Details</button>
                                    </td>`);
                    row.append(detailsButton);
                    $('#data-table tbody').append(row); // 'row' is appended to the table here
                });
            }

            // Show details dialog
            $(document).on('click', '.view-description', function() {
                const item = $(this).data('item');

                // Set the content in the dialog
                $('#description-content').text($(this).data('description')); // Set the description text
                $('#short-contract-content').text($(this).data('short_contract')); // Set the short contract text
                $('#long-contract-content').text($(this).data('long_contract')); // Set the long contract text
                $('#credit-content').text($(this).data('short_premium') || 'N/A');
                $('#debit-content').text($(this).data('long_premium') || 'N/A');
                $('#max-risk-content').text($(this).data('max_risk') || 'N/A');
                $('#max-reward-content').text($(this).data('max_reward') || 'N/A');
                $('#breakeven-content').text($(this).data('breakeven') || 'N/A');
                $('#entry-price-content').text($(this).data('entry_price') || 'N/A');
                $('#target-price-content').text($(this).data('target_price') || 'N/A');
                $('#stop-price-content').text($(this).data('stop_price') || 'N/A');
                $('#exit-date-content').text($(this).data('exit_date') || 'N/A');
                $('#overlay').show(); // Show the overlay
                $('#dialog').show(); // Show the dialog
            });
            // Close dialog
            $('#close-dialog').on('click', function() {
                $('#overlay').hide(); // Hide the overlay
                $('#dialog').hide(); // Hide the dialog
            });

            $('.filter-input').on('keyup', function() {
                const filters = $('.filter-input').map(function() {
                    return $(this).val().toLowerCase();
                }).get();

                const filteredData = previousData.filter(item => {
                    return (
                        (item.underlying_ticker || '').toLowerCase().includes(filters[0]) &&
                        (JSON.stringify(item.option).toLowerCase()).includes(filters[1])
                    );
                });
                renderTable(filteredData);
            });

            $('#filter-exit-date').on('change', function() {
                renderTable(previousData); // Re-render the table when the checkbox state changes
            });

            refreshData();
        });
    </script>
</body>
</html>