<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souag Investment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .filter-input {
            width: 100%;
            box-sizing: border-box;
        }
        .record {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .record-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .record-details {
            margin-left: 10px;
            display: inline-block;
            vertical-align: top;
            width: 100%;
        }
        .data-container {
            display: flex;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
        }
        .column {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
        }
        #main-data-container {
            flex: 2;
        }
        .details-container {
            display: none;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 90%; /* Reduced font size */
        }
        .details-container .column {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
        }
        body {
            font-size: 120%;
        }
        .viewport {
            overflow-x: auto;
        }
        .data-row-container {
            display: flex;
            flex-direction: column;
        }
        td {
            padding: 20px;
        }
        th.sortable {
            cursor: pointer;
        }
        th.sortable:after {
            content: '\25B2'; /* Up arrow */
            float: right;
        }
        th.sortable.desc:after {
            content: '\25BC'; /* Down arrow */
        }
    </style>
</head>
<body>
    <h1>Mousoutrade vertical spread analysis</h1>
    <div id="filter-section">
        <input type="text" class="filter-input" placeholder="Filter Ticker" />
        <label>
            <input type="checkbox" id="filter-exit-date" checked /> Show only records with a spread strategy
        </label>
    </div>
    
    <div class="data-container">
        <div id="main-data-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="ticker">Spread Info</th>
                        <th class="sortable" data-sort="max_risk">Max Risk</th>
                        <th class="sortable" data-sort="max_reward">Max Profit</th>
                        <th class="sortable" data-sort="probability_of_profit">PoP</th>
                        <th>Description</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let previousData = [];
            let sortOrders = {};

            function refreshData() {
                $.ajax({
                    url: '/data',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        previousData = data;
                        renderData(data);
                    },
                    error: function(error) {
                        console.error("Error loading data:", error);
                    }
                });
            }

            function renderData(data) {
                $('#main-data-container tbody').empty();

                const filterExitDate = $('#filter-exit-date').is(':checked');
                const filteredData = filterExitDate ? data.filter(item => item.exit_date) : data;

                const sortedData = filteredData.sort((a, b) => {
                    for (const [column, order] of Object.entries(sortOrders)) {
                        if (a[column] > b[column]) return order === 'asc' ? 1 : -1;
                        if (a[column] < b[column]) return order === 'asc' ? -1 : 1;
                    }
                    return 0;
                });

                const groupedData = sortedData.reduce((acc, item) => {
                    if (!acc[item.underlying_ticker]) {
                        acc[item.underlying_ticker] = [];
                    }
                    acc[item.underlying_ticker].push(item);
                    return acc;
                }, {});

                $.each(groupedData, function(ticker, items) {
                    items.forEach((item) => {
                        console.log("Content of item:", item);
                        try {
                            let row = $('<tr>');
                            row.append(`
                                <td>
                                    <strong>Ticker:</strong> ${ticker || 'N/A'}<br>
                                    <strong>Expiration Date:</strong> ${item.expiration_date || 'N/A'}<br>
                                    <strong>Update Date:</strong> ${item.update_date || 'N/A'}<br>
                                    <strong>Strategy:</strong> ${item.strategy}<br>
                                    <strong>Direction:</strong> ${item.direction}
                                </td>
                            `);
                            row.append(`<td>$${item.max_risk}</td>`);
                            row.append(`<td>$${item.max_reward}</td>`);
                            row.append(`<td>${item.probability_of_profit}%</td>`);
                            row.append(`<td>${item.description || 'N/A'}</td>`);

                            const detailsButton = $(`<button class="view-description" 
                                data-short_premium="${item.short_premium || 'N/A'}" 
                                data-long_premium="${item.long_premium || 'N/A'}" 
                                data-max_risk="${item.max_risk || 'N/A'}" 
                                data-max_reward="${item.max_reward || 'N/A'}" 
                                data-breakeven="${item.breakeven || 'N/A'}" 
                                data-entry_price="${item.entry_price || 'N/A'}" 
                                data-target_price="${item.target_price || 'N/A'}" 
                                data-stop_price="${item.stop_price || 'N/A'}" 
                                data-exit_date="${item.exit_date || 'N/A'}" 
                                data-short_contract="${item.short_contract ? item.short_contract.ticker + ' (' + item.short_contract.strike_price + ')' : 'N/A'}" 
                                data-long_contract="${item.long_contract ? item.long_contract.ticker + ' (' + item.long_contract.strike_price + ')' : 'N/A'}" 
                                data-percentage_max_risk="${item.percentage_max_risk || 'N/A'}"
                                data-percentage_max_reward="${item.percentage_max_profit || 'N/A'}">Details</button>`);

                            row.append($('<td>').append(detailsButton));
                            $('#main-data-container tbody').append(row);

                            const detailsContainer = $(`
                                <tr class="details-container">
                                    <td colspan="4">
                                        <ul>
                                            <li><strong>Credit:</strong> <span class="credit-content"></span></li>
                                            <li><strong>Debit:</strong> <span class="debit-content"></span></li>
                                            <li><strong>Max Risk:</strong> <span class="max-risk-content"></span></li>
                                            <li><strong>Max Reward:</strong> <span class="max-reward-content"></span></li>
                                            <li><strong>Breakeven:</strong> <span class="breakeven-content"></span></li>
                                        </ul>
                                    </td>
                                    <td colspan="4">
                                        <ul>
                                            <li><strong>Entry Price:</strong> <span class="entry-price-content"></span></li>
                                            <li><strong>Target Price:</strong> <span class="target-price-content"></span></li>
                                            <li><strong>Stop Price:</strong> <span class="stop-price-content"></span></li>
                                            <li><strong>Exit Date:</strong> <span class="exit-date-content"></span></li>
                                            <li><strong>Short Contract:</strong> <span class="short-contract-content"></span></li>
                                            <li><strong>Long Contract:</strong> <span class="long-contract-content"></span></li>
                                        </ul>
                                    </td>
                                </tr>
                            `);
                            row.after(detailsContainer);
                        } catch (error) {
                            console.error("Error rendering data for item:", item, error);
                        }
                    });
                });
            }

            $(document).on('click', '.view-description', function() {
                try {
                    const detailsRow = $(this).closest('tr').next('.details-container');
                    detailsRow.find('.credit-content').text($(this).data('short_premium') || 'N/A');
                    detailsRow.find('.debit-content').text($(this).data('long_premium') || 'N/A');
                    detailsRow.find('.max-risk-content').text($(this).data('max_risk') || 'N/A');
                    detailsRow.find('.max-reward-content').text($(this).data('max_reward') || 'N/A');
                    detailsRow.find('.breakeven-content').text($(this).data('breakeven') || 'N/A');
                    detailsRow.find('.entry-price-content').text($(this).data('entry_price') || 'N/A');
                    detailsRow.find('.target-price-content').text($(this).data('target_price') || 'N/A');
                    detailsRow.find('.stop-price-content').text($(this).data('stop_price') || 'N/A');
                    detailsRow.find('.exit-date-content').text($(this).data('exit_date') || 'N/A');
                    detailsRow.find('.short-contract-content').text($(this).data('short_contract'));
                    detailsRow.find('.long-contract-content').text($(this).data('long_contract'));
                    detailsRow.toggle();
                } catch (error) {
                    console.error("Error displaying details:", error);
                }
            });

            $('.filter-input').on('keyup', function() {
                try {
                    const filters = $('.filter-input').map(function() {
                        return $(this).val().toLowerCase();
                    }).get();

                    const filteredData = previousData.filter(item => {
                        return (
                            (item.underlying_ticker || '').toLowerCase().includes(filters[0])
                        );
                    });
                    renderData(filteredData);
                } catch (error) {
                    console.error("Error filtering data:", error);
                }
            });

            $('#filter-exit-date').on('change', function() {
                try {
                    renderData(previousData);
                } catch (error) {
                    console.error("Error applying filter:", error);
                }
            });

            $('th.sortable').on('click', function() {
                const column = $(this).data('sort');
                sortOrders[column] = sortOrders[column] === 'asc' ? 'desc' : 'asc';
                $(this).toggleClass('desc', sortOrders[column] === 'desc');
                renderData(previousData);
            });

            refreshData();
        });
    </script>
</body>
</html>